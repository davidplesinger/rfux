<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acer Burza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Trebuchet MS', sans-serif; background-color: #f4f4f4; color: #333; }
        .header-acer { background-color: #80C343; color: white; padding: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cnb-bar { background-color: #333; color: #fff; padding: 8px 0; font-size: 0.9rem; text-align: center; }
        
        .card { border: none; border-radius: 12px; transition: transform 0.2s; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .card-img-top { height: 200px; object-fit: contain; padding: 20px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .card-body { padding: 20px; display: flex; flex-direction: column; background: #fff; border-radius: 0 0 12px 12px;}
        
        .product-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .product-desc { font-size: 0.9rem; color: #444; margin-bottom: 10px; font-style: italic; }
        .tech-specs { font-size: 0.85rem; color: #666; margin-bottom: 15px; }
        
        .stav-badge { position: absolute; top: 15px; left: 15px; padding: 5px 12px; border-radius: 8px; font-weight: bold; color: white; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: help; z-index: 2; }
        .stav-A { background-color: #80C343; } 
        .stav-B { background-color: #0078D7; } 
        .stav-C { background-color: #F28C28; } 
        
        .status-badge { position: absolute; top: 15px; right: 15px; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; z-index: 2; }
        .status-active { background-color: #333; color: white; }
        .status-sold { background-color: #898988; color: white; }

        .price-box { background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: auto; border: 1px solid #e9ecef; }
        .price-eur { font-size: 1.6rem; color: #80C343; font-weight: bold; line-height: 1; }
        .price-czk { font-size: 1rem; color: #555; font-weight: bold; margin-top: 4px; }
        .price-old { text-decoration: line-through; color: #898988; font-size: 0.85rem; }
        
        .meta-info { font-size: 0.8rem; color: #777; margin-top: 10px; display: flex; justify-content: space-between; }
        .bids-badge { background-color: #e9ecef; color: #333; padding: 3px 8px; border-radius: 12px; font-weight: bold; }

        .btn-acer { background-color: #80C343; color: white; border-radius: 25px; padding: 8px 20px; width: 100%; font-weight: bold; margin-top: 15px; text-decoration: none; display: block; text-align: center; }
        .btn-acer:hover { background-color: #6DA838; color: white; }
        .btn-disabled { background-color: #e0e0e0; color: #898988; pointer-events: none; margin-top: 15px; text-align: center; display: block; padding: 8px; border-radius: 25px; }

        /* Vzhled prodaných karet */
        .sold-card { filter: grayscale(80%); opacity: 0.85; }
        .sold-card:hover { filter: grayscale(30%); opacity: 1; }
        
        .divider-container { display: none; width: 100%; text-align: center; margin: 50px 0 30px 0; }
        .divider-container hr { border-top: 3px solid #898988; width: 200px; margin: 0 auto 15px auto; opacity: 1; }
        .divider-container h3 { color: #898988; font-size: 1.2rem; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="cnb-bar">
        Aktuální kurz ČNB střed: <strong id="cnb-rate">Načítám...</strong>
    </div>

    <div class="header-acer text-center">
        <h2 class="mb-0">aukční portál enfinitec</h2>
    </div>

    <div class="container mb-5">
        
        <div id="active-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mt-2">
            <div class="text-center w-100 mt-5" id="loading-spinner">
                <div class="spinner-border text-success" role="status"></div>
                <p class="mt-2">Příprava katalogu...</p>
            </div>
        </div>

        <div id="sold-divider" class="divider-container">
            <hr>
            <h3>Prodáno / Vyřazeno</h3>
        </div>

        <div id="sold-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4"></div>

    </div>

    <script>
        // --- KONFIGURACE ---
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfOJzHS5TteB4jDdVfMMdhFcVDGK1Oqh7ad1A6bXLhdPvuju1mrldVFaie7uyt2pVO1_s2RHCrmU3v/pub?gid=0&single=true&output=csv"; 
        const PLUMSAIL_FORM_URL = "https://forms.plumsail.com/ece12aa2-a403-487b-b616-3718a3764dc7"; // DOPLNIT

        let eurRate = 25.30; 
        
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchCNBRate();
            loadCatalog();
        });

        async function fetchCNBRate() {
            try {
                const cnbUrl = 'https://www.cnb.cz/cs/financni-trhy/devizovy-trh/kurzy-devizoveho-trhu/kurzy-devizoveho-trhu/denni_kurz.txt';
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(cnbUrl)}`);
                const data = await response.json();
                const lines = data.contents.split('\n');
                const eurLine = lines.find(line => line.includes('|EUR|'));
                if (eurLine) {
                    eurRate = parseFloat(eurLine.split('|')[4].replace(',', '.'));
                    document.getElementById('cnb-rate').innerText = `1 EUR = ${eurRate.toFixed(3).replace('.', ',')} CZK`;
                }
            } catch (error) {
                document.getElementById('cnb-rate').innerText = `1 EUR = ${eurRate.toFixed(3).replace('.', ',')} CZK (Záložní kurz)`;
            }
        }

        async function loadCatalog() {
            try {
                const response = await fetch(`${GOOGLE_SHEET_CSV_URL}&t=${new Date().getTime()}`);
                const csvText = await response.text();
                const products = parseCSV(csvText);
                renderProducts(products);
            } catch (error) {
                document.getElementById('active-grid').innerHTML = `<div class="alert alert-danger w-100 text-center">Chyba načítání dat z tabulky.</div>`;
            }
        }

        function parseCSV(csvText) {
            const result = []; let row = []; let value = ''; let inQuotes = false;
            for (let i = 0; i < csvText.length; i++) {
                let char = csvText[i];
                if (char === '"') {
                    if (inQuotes && csvText[i + 1] === '"') { value += '"'; i++; } 
                    else { inQuotes = !inQuotes; }
                } 
                else if (char === ',' && !inQuotes) { row.push(value.trim()); value = ''; } 
                else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (char === '\r' && csvText[i + 1] === '\n') i++;
                    row.push(value.trim());
                    if (row.join('').trim() !== '') result.push(row);
                    row = []; value = '';
                } 
                else { value += char; }
            }
            if (value !== '' || row.length > 0) { row.push(value.trim()); if (row.join('').trim() !== '') result.push(row); }
            
            const headers = result[0]; const data = [];
            for (let i = 1; i < result.length; i++) {
                const obj = {};
                for (let j = 0; j < headers.length; j++) { obj[headers[j]] = result[i][j] || ''; }
                data.push(obj);
            }
            return data;
        }

        // --- ŘAZENÍ A VYKRESLENÍ ---
        function renderProducts(products) {
            const activeGrid = document.getElementById('active-grid');
            const soldGrid = document.getElementById('sold-grid');
            const divider = document.getElementById('sold-divider');
            
            activeGrid.innerHTML = "";
            soldGrid.innerHTML = "";

            let activeItems = [];
            let soldItems = [];

            // Rozdělení podle stavu
            products.forEach(p => {
                const stat = (p['Status'] || '').toLowerCase();
                if (stat.includes('prod') || stat.includes('vyřazen') || stat.includes('stažen')) {
                    soldItems.push(p);
                } else {
                    activeItems.push(p);
                }
            });

            // Pomocná funkce pro bezpečné datum
            const parseDate = (d) => (d && d !== 'N/A') ? new Date(d) : new Date(0);

            // Seřazení aktivních (Nejnovější ZalistovanoDne první vlevo nahoře)
            activeItems.sort((a, b) => parseDate(b['ZalistovanoDne']) - parseDate(a['ZalistovanoDne']));
            
            // Seřazení prodaných (Nejnovější DealDate/ZalistovanoDne první)
            soldItems.sort((a, b) => {
                let dateA = (a['DealDate'] && a['DealDate'] !== 'N/A') ? a['DealDate'] : a['ZalistovanoDne'];
                let dateB = (b['DealDate'] && b['DealDate'] !== 'N/A') ? b['DealDate'] : b['ZalistovanoDne'];
                return parseDate(dateB) - parseDate(dateA);
            });
            
            // Omezení na posledních 6 prodaných
            soldItems = soldItems.slice(0, 6);

            // Vykreslení karet
            if(activeItems.length === 0) activeGrid.innerHTML = `<h5 class="w-100 text-center text-muted">Aktuálně nejsou žádné aktivní nabídky.</h5>`;
            activeItems.forEach(p => activeGrid.innerHTML += generateCardHtml(p, false));

            if (soldItems.length > 0) {
                divider.style.display = "block";
                soldItems.forEach(p => soldGrid.innerHTML += generateCardHtml(p, true));
            }
        }

        // --- ŠABLONA KARTY ---
        function generateCardHtml(p, isSoldCategory) {
            const title = p['Title'] || 'N/A';
            const popis = p['Popis'] || '';
            const id = p['ID'] || '';
            const image = p['ImageURL'] || 'https://via.placeholder.com/300?text=Bez+fotky';
            const status = p['Status'] || 'Aktivní';
            const pn = p['PartNumber'] || 'N/A';
            const lok = p['Lokalizace'] || 'N/A';
            
            // Logika stavu (A/B/C) a Nápovědy
            let rawStav = p['StavZarizeni'] || p['Stav'] || 'C';
            let stav = rawStav.trim().substring(0, 1).toUpperCase(); // Ošetření, kdyby text byl např. "Stav A"
            if(!['A','B','C'].includes(stav)) stav = 'C';

            let stavDesc = "";
            if (stav === 'A') stavDesc = "Prakticky nový produkt, bez známek používání (DOA reklamace)";
            else if (stav === 'B') stavDesc = "Jako nový produkt, s mírnými známkami použití (z výstavy, demovzorek,...)";
            else if (stav === 'C') stavDesc = "Používaný produkt, připravený autorizovaným servisem na novou životní etapu (pozdní oprava během reklamace a pod.)";
            
            let stavColorClass = stav === 'A' ? 'stav-A' : (stav === 'B' ? 'stav-B' : 'stav-C');

            const priplatekKlav = parseFloat(p['PriplatekKlavesnice']) || 0;
            const priceStartEur = parseFloat(p['StartPrice']) || 0;
            const priceCurrEur = parseFloat(p['CurrentPrice']) || 0;
            
            // Oprava procent (Pokud Google posílá "0.02", skript z toho udělá "2")
            let dropRaw = parseFloat(p['DenniPoklesProcenta']) || 0;
            let dropPct = (dropRaw > 0 && dropRaw < 1) ? Math.round(dropRaw * 100) : dropRaw;

            const pocetNabidek = parseInt(p['PocetNabidek']) || 0;
            
            const priceCurrCzk = Math.round(priceCurrEur * eurRate);
            const discountCzk = Math.round((priceStartEur - priceCurrEur) * eurRate);
            
            let daysListed = 'N/A';
            if (p['ZalistovanoDne'] && p['ZalistovanoDne'] !== 'N/A') {
                const diffTime = Math.abs(new Date() - new Date(p['ZalistovanoDne']));
                daysListed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            }

            const badgeClass = isSoldCategory ? 'status-sold' : 'status-active';
            const badgeText = status.toUpperCase();
            const btnClass = isSoldCategory ? 'btn-disabled' : 'btn-acer';
            const cardCssClass = isSoldCategory ? 'sold-card' : '';
            
            let klavText = priplatekKlav > 0 ? `<div class="text-danger mt-1" style="font-size:0.8rem;">+ Výměna klávesnice: ${priplatekKlav} €</div>` : '';
            let slevaText = discountCzk > 0 ? `<div class="text-success mt-1" style="font-size:0.85rem; font-weight:bold;">Sleva: ${discountCzk.toLocaleString('cs-CZ')} Kč</div>` : '';

            return `
            <div class="col">
                <div class="card ${cardCssClass}">
                    <span class="stav-badge ${stavColorClass}" title="${stavDesc}">Stav ${stav}</span>
                    <span class="status-badge ${badgeClass}">${badgeText}</span>
                    
                    <img src="${image}" class="card-img-top" alt="Foto">
                    
                    <div class="card-body">
                        <div class="product-title">${title}</div>
                        <div class="product-desc">${popis}</div>
                        <div class="tech-specs">
                            <strong>PN:</strong> ${pn}<br>
                            <strong>Lok:</strong> ${lok}<br>
                            <strong>Denní pokles:</strong> ${dropPct} %
                        </div>
                        
                        <div class="price-box">
                            <div class="price-old">Původně: €${priceStartEur.toFixed(0)}</div>
                            <div class="price-eur">€${priceCurrEur.toFixed(0)}</div>
                            <div class="price-czk">cca ${priceCurrCzk.toLocaleString('cs-CZ')} Kč</div>
                            ${slevaText}
                            ${klavText}
                        </div>

                        <div class="meta-info">
                            <span>V nabídce: <strong>${daysListed} dní</strong></span>
                            <span class="bids-badge">Nabídek: ${pocetNabidek}</span>
                        </div>

${isSoldCategory ? 
    `<button class="btn btn-disabled" disabled>Nedostupné</button>` : 
    `<button onclick="openBidModal('${encodeURIComponent(title)}', ${priceCurrEur}, '${id}')" class="btn btn-acer">Zadat nabídku v €</button>`
}
                    </div>
                </div>
            </div>`;
        }
    
    
// Funkce pro otevření okna a předání parametrů produktu
function openBidModal(encodedTitle, price, id) {
    // Použijeme vaši novou URL s layoutem a připojíme k ní parametry produktu
    const formUrl = `https://acerczech.plumsail.io/ece12aa2-a403-487b-b616-3718a3764dc7?layout=617e1c0d-2b1e-420e-864c-937360d175a5&produkt=${encodedTitle}&cena=${price}&id=${id}`;
    
    // Změníme zdroj uvnitř modálního okna
    document.getElementById('plumsail-iframe').src = formUrl;
    
    // Zobrazíme modální okno přes Bootstrap
    const bidModal = new bootstrap.Modal(document.getElementById('bidModal'));
    bidModal.show();
}

// Naslouchání "tajnému signálu" z Plumsail formuláře pro automatické zavření po úspěchu
window.addEventListener('message', function (event) {
    if (event.data === "zavriModul") {
        // Najdeme aktivní okno a zavřeme ho
        const modalElement = document.getElementById('bidModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }
        
        // Vizuální potvrzení pro uživatele (můžete upravit dle libosti)
        alert("Děkujeme, vaše nabídka byla úspěšně přijata a zařazena do systému.");
        
        // Vyčistíme iframe pro příští použití
        document.getElementById('plumsail-iframe').src = "";
    }
});
    
    
    </script>
<div class="modal fade" id="bidModal" tabindex="-1" aria-labelledby="bidModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bidModalLabel">Odeslat nabídku</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="plumsail-iframe" src="" width="100%" height="600" frameborder="0" style="border: none;"></iframe>
      </div>
    </div>
  </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>





